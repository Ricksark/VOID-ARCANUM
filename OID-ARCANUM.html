<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title><$BlogPageTitle$></title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg: #05080f; 
            --surface: #10141f;
            --primary: #2b6eff; 
            --text: #ffffff;
            --bubble-me: #154cce; 
            --bubble-them: #2a2a2a;
            --timestamp-color: rgba(255, 255, 255, 0.6);
            --danger: #ff4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; background: var(--bg); z-index: 1; }
        .active { display: flex !important; z-index: 10; }
        .center-container { display: flex; align-items: center; justify-content: center; height: 100%; padding: 20px; }
        .card { background: var(--surface); padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; border: 1px solid #1e263b; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }

        h2 { margin-bottom: 20px; color: var(--primary); letter-spacing: 1px; text-transform: uppercase; font-size: 1.5rem; }
        input { width: 100%; padding: 15px; background: #080b14; border: 1px solid #2d3748; color: white; border-radius: 10px; margin-bottom: 15px; font-size: 1rem; }
        
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; background: var(--primary); color: white; margin-bottom: 10px; }
        button:active { transform: scale(0.96); }
        .btn-sec { background: transparent; color: #888; border: 1px solid #2d3748; }

        .profile-upload { width: 90px; height: 90px; border-radius: 50%; background: #161b29; margin: 0 auto 20px; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .profile-upload img { width: 100%; height: 100%; object-fit: cover; }

        #chat-header { padding: 15px; background: var(--surface); border-bottom: 1px solid #1e263b; display: flex; align-items: center; justify-content: space-between; height: 70px; }
        .header-info { display: flex; align-items: center; gap: 10px; }
        .header-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--primary); }

        #chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; position: relative; display: flex; flex-direction: column; }
        .msg.me { align-self: flex-end; background: var(--bubble-me); border-bottom-right-radius: 4px; }
        .msg.them { align-self: flex-start; background: var(--bubble-them); border-bottom-left-radius: 4px; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        
        /* Audio Player Styling */
        audio { height: 35px; width: 200px; margin-top: 5px; filter: invert(100%); opacity: 0.8; }
        
        .msg-time { font-size: 0.65rem; color: var(--timestamp-color); align-self: flex-end; margin-top: 4px; }

        #chat-input-area { padding: 15px; background: var(--surface); border-top: 1px solid #1e263b; display: flex; gap: 8px; align-items: center;}
        #msg-input { margin-bottom: 0; flex: 1; }
        
        .icon-btn { background: none; box-shadow: none; width: auto; padding: 8px; margin: 0; color: #888; font-size: 1.2rem; position: relative; }
        .icon-btn.recording { color: var(--danger); animation: pulse 1.5s infinite; }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1a1f2e; border: 1px solid var(--primary); color: white; padding: 10px 20px; border-radius: 30px; z-index: 100; display: none; }
    </style>
</head>
<body>

    <div id="toast">Notification</div>

    <!-- 1. AUTH SCREEN -->
    <div id="screen-auth" class="screen active center-container">
        <div class="card">
            <h2><$BlogPageTitle$></h2>
            <form id="form-register" style="display:none;">
                <div class="profile-upload" onclick="document.getElementById('file-in').click()">
                    <img id="prev-img" style="display:none;">
                    <i class="fas fa-camera" id="prev-icon" style="color:#666;"></i>
                </div>
                <input type="file" id="file-in" accept="image/*" hidden onchange="handleImage(this, 'reg')">
                <input type="text" id="reg-name" placeholder="Display Name">
                <input type="email" id="reg-email" placeholder="Email">
                <input type="password" id="reg-pass" placeholder="Password">
                <button type="button" onclick="register()">Create Secure ID</button>
                <button type="button" class="btn-sec" onclick="toggleAuth(false)">Back to Login</button>
            </form>
            <form id="form-login">
                <input type="email" id="log-email" placeholder="Email">
                <input type="password" id="log-pass" placeholder="Password">
                <button type="button" onclick="login()">Enter Securely</button>
                <button type="button" class="btn-sec" onclick="toggleAuth(true)">New Account</button>
            </form>
        </div>
    </div>

    <!-- 2. DASHBOARD -->
    <div id="screen-lobby" class="screen center-container">
        <div class="card">
            <img id="dash-img" src="" style="width:70px; height:70px; border-radius:50%; object-fit:cover; border:2px solid var(--primary); margin-bottom:10px;">
            <h3 id="dash-name">User</h3>
            <div style="border-top:1px solid #1e263b; margin:20px 0; padding-top:20px;">
                <button onclick="createRoom()"><i class="fas fa-satellite-dish"></i> Create Room</button>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="join-code" placeholder="Enter Room ID" style="text-align:center; margin:0;">
                    <button style="width:auto; margin:0;" onclick="joinRoom()"><i class="fas fa-plug"></i></button>
                </div>
            </div>
            <button class="btn-sec" onclick="location.reload()">Logout</button>
        </div>
    </div>

    <!-- 3. CONNECTING SCREEN -->
    <div id="screen-wait" class="screen center-container">
        <div class="card">
            <div class="fas fa-circle-notch fa-spin" style="font-size:2rem; color:var(--primary); margin-bottom:15px;"></div>
            <h3 id="wait-text">Generating ID...</h3>
            <div id="my-id-display" style="font-size:1.5rem; background:#080b14; padding:15px; margin:15px 0; border:1px dashed var(--primary); border-radius:10px; letter-spacing: 2px; font-family: monospace;">...</div>
            <button onclick="copyShareLink()"><i class="fas fa-copy"></i> Copy Direct Link</button>
            <button class="btn-sec" onclick="location.reload()">Cancel</button>
        </div>
    </div>

    <!-- 4. CHAT SCREEN -->
    <div id="screen-chat" class="screen">
        <div id="chat-header">
            <div class="header-info">
                <img id="chat-remote-img" class="header-avatar" src="">
                <div>
                    <div id="chat-remote-name" style="font-weight:bold;">Unknown</div>
                    <div style="font-size:0.7rem; color:var(--primary);"><i class="fas fa-lock"></i> Secure P2P</div>
                </div>
            </div>
            <button class="btn-sec" onclick="location.reload()" style="width:auto; padding:8px 15px; border-color: var(--danger); color:var(--danger);">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="file" id="chat-file-in" accept="image/*" hidden onchange="handleImage(this, 'chat')">
            <button class="icon-btn" onclick="document.getElementById('chat-file-in').click()"><i class="fas fa-image"></i></button>
            
            <!-- Voice Message Button -->
            <button id="mic-btn" class="icon-btn" onclick="toggleRecording()"><i class="fas fa-microphone"></i></button>
            
            <input type="text" id="msg-input" placeholder="Type message..." autocomplete="off">
            <button id="send-btn" class="icon-btn" style="color:var(--primary)" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        const ICE_SERVERS = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478' }] };
        let user = null, peer = null, conn = null, tempImg = null;
        
        // Voice Recording Variables
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // --- AUTH ---
        async function hashPass(str) {
            const enc = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', enc);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function handleImage(input, mode) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    if (mode === 'reg') {
                        tempImg = e.target.result;
                        document.getElementById('prev-img').src = tempImg;
                        document.getElementById('prev-img').style.display = 'block';
                        document.getElementById('prev-icon').style.display = 'none';
                    } else {
                        sendData(e.target.result, 'IMG');
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function register() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            if(!name || !email || !pass) return showToast("All fields required");
            const hashed = await hashPass(pass);
            const userData = { name, email, pass: hashed, img: tempImg || 'https://www.gravatar.com/avatar/0?d=mp' };
            localStorage.setItem('ghost_' + email, JSON.stringify(userData));
            showToast("Account Created!"); toggleAuth(false);
        }

        async function login() {
            const email = document.getElementById('log-email').value;
            const pass = document.getElementById('log-pass').value;
            const data = localStorage.getItem('ghost_' + email);
            if(!data) return showToast("User not found");
            const userData = JSON.parse(data);
            if(userData.pass === await hashPass(pass)) {
                user = userData;
                initLobby();
                checkUrlParams();
            } else showToast("Invalid Password");
        }

        function toggleAuth(showReg) {
            document.getElementById('form-login').style.display = showReg ? 'none' : 'block';
            document.getElementById('form-register').style.display = showReg ? 'block' : 'none';
        }

        function initLobby() {
            showScreen('screen-lobby');
            document.getElementById('dash-name').innerText = user.name;
            document.getElementById('dash-img').src = user.img;
        }

        // --- NETWORKING ---
        function createRoom() {
            showScreen('screen-wait');
            const id = Math.random().toString(36).substr(2, 6).toUpperCase();
            peer = new Peer(id, ICE_SERVERS);
            peer.on('open', (myId) => {
                document.getElementById('wait-text').innerText = "Waiting for partner...";
                document.getElementById('my-id-display').innerText = myId;
            });
            peer.on('connection', handleConnection);
        }

        function joinRoom(id) {
            const destId = id || document.getElementById('join-code').value.trim().toUpperCase();
            if(!destId) return showToast("Enter an ID");
            showScreen('screen-wait');
            document.getElementById('wait-text').innerText = "Connecting...";
            peer = new Peer(ICE_SERVERS);
            peer.on('open', () => handleConnection(peer.connect(destId)));
            peer.on('error', () => { showToast("Room not found"); showScreen('screen-lobby'); });
        }

        function handleConnection(c) {
            conn = c;
            conn.on('open', () => {
                conn.send({ type: 'INFO', name: user.name, img: user.img });
                showScreen('screen-chat');
                addSystemMsg("Connected");
            });
            conn.on('data', data => {
                if(data.type === 'INFO') {
                    document.getElementById('chat-remote-name').innerText = data.name;
                    document.getElementById('chat-remote-img').src = data.img;
                } else if (data.type === 'MSG') {
                    addMessage(data.text, 'them', data.time, 'text');
                } else if (data.type === 'IMG') {
                    addMessage(data.data, 'them', data.time, 'image');
                } else if (data.type === 'VOICE') {
                    addMessage(data.data, 'them', data.time, 'voice');
                }
            });
        }

        function copyShareLink() {
            const id = document.getElementById('my-id-display').innerText;
            const url = window.location.origin + window.location.pathname + '?room=' + id;
            navigator.clipboard.writeText(url);
            showToast("Link copied!");
        }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const roomId = params.get('room');
            if (roomId) {
                window.history.replaceState({}, document.title, window.location.pathname);
                joinRoom(roomId);
            }
        }

        // --- VOICE LOGIC ---
        async function toggleRecording() {
            const btn = document.getElementById('mic-btn');
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.onload = e => sendData(e.target.result, 'VOICE');
                        reader.readAsDataURL(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    showToast("Recording...");
                } catch (err) {
                    showToast("Microphone access denied");
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording');
            }
        }

        // --- CHAT LOGIC ---
        function formatTime() { return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !conn) return;
            const time = formatTime();
            conn.send({ type: 'MSG', text: text, time: time });
            addMessage(text, 'me', time, 'text');
            input.value = '';
        }

        function sendData(data, type) {
            if(!conn) return;
            const time = formatTime();
            conn.send({ type: type, data: data, time: time });
            addMessage(data, 'me', time, type.toLowerCase());
        }

        function addMessage(content, type, time, contentType) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'msg ' + type;
            
            if (contentType === 'text') {
                const span = document.createElement('span');
                span.innerText = content;
                div.appendChild(span);
            } else if (contentType === 'image' || contentType === 'img') {
                const img = document.createElement('img');
                img.src = content;
                div.appendChild(img);
            } else if (contentType === 'voice') {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = content;
                div.appendChild(audio);
            }

            const timeSpan = document.createElement('span');
            timeSpan.className = 'msg-time';
            timeSpan.innerText = time;
            div.appendChild(timeSpan);

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.style = "text-align:center; color:#555; font-size:0.7rem; margin:10px;";
            div.innerText = text;
            document.getElementById('chat-messages').appendChild(div);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        document.getElementById('msg-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendMsg(); });
    </script>
</body>
</html>
